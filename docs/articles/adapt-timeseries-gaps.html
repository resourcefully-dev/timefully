<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Gaps in `adapt_timeseries()` • timefully</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Gaps in `adapt_timeseries()`">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">timefully</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/timefully.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/adapt-timeseries-gaps.html">Gaps in `adapt_timeseries()`</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/resourcefully-dev/timefully/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Gaps in `adapt_timeseries()`</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/resourcefully-dev/timefully/blob/HEAD/vignettes/adapt-timeseries-gaps.Rmd" class="external-link"><code>vignettes/adapt-timeseries-gaps.Rmd</code></a></small>
      <div class="d-none name"><code>adapt-timeseries-gaps.Rmd</code></div>
    </div>

    
    
<p>When adapting time series data to new date ranges with
<code><a href="../reference/adapt_timeseries.html">adapt_timeseries()</a></code>, we sometimes encounter gaps in the
output where no historical data is available to fill in. This vignette
explains why these gaps occur and how we handle them.</p>
<div class="section level2">
<h2 id="how-adapt_timeseries-works">How <code>adapt_timeseries()</code> works<a class="anchor" aria-label="anchor" href="#how-adapt_timeseries-works"></a>
</h2>
<p>This function adapts the date range of a time series by reusing
historical patterns based on the same weekday occurrence within the year
and decimal hour of the day. For example, if we have 2023 data and we
want to fill in data for 01/01/2025 02:30, we see that it’s the
<strong>first Thursday of 2025</strong>, so we use the observation from
2.5 hours on the first Thursday of 2023.</p>
<p>In summary, the <code><a href="../reference/adapt_timeseries.html">adapt_timeseries()</a></code> function consists in
two main actions:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Check the input series.</strong> The function looks for
missing values in every column after <code>datetime</code>. If there are
<code>NA</code> values and <code>fill_gaps = FALSE</code> it stops early
with an informative error; otherwise it calls
<code><a href="../reference/fill_from_past.html">fill_from_past()</a></code> so the input itself has no gaps.</li>
<li>
<strong>Adapt date range</strong> For every pair of
<code><a href="../reference/ywday.html">ywday()</a></code> (weekday occurrence within the year) and
<code><a href="../reference/dhours.html">dhours()</a></code> (decimal hour) the function grabs the most recent
observation and copies it into missing rows with the same pair.</li>
</ol>
</div>
<div class="section level2">
<h2 id="the-full-year-problem">The full-year problem<a class="anchor" aria-label="anchor" href="#the-full-year-problem"></a>
</h2>
<p>This pipeline works well until we cross years with a different number
of weekdays. In the example below we see that 2023 has 52 Mondays and
Tuesdays, while 2024 (a leap year) has 53 of each. This means that we
can’t find historical data for the “53rd Monday” or “53rd Tuesday” of
2024, because they simply do not exist in 2023, so the output keeps
<code>NA</code>.</p>
<p><img src="problem.png" class="r-plt" alt="Table comparing 2023, 2024 leap year, and 2025 weekdays showing extra 53rd Monday and Tuesday in 2024 and 2025 outlined in red." width="90%" style="display: block; margin: auto;"></p>
<p>To cover those extra weekdays we use a second step: whenever the join
fails but the missing data is limited to at most two consecutive days
(to cover leap years), we call <code><a href="../reference/fill_from_past.html">fill_from_past()</a></code> and copy
the most recent observation for the same clock time one week earlier.
This reaches back to the “52nd Monday/Tuesday” that does exit, which
fills the previously empty rows.</p>
<p><img src="solution.png" class="r-plt" alt="Table highlighting that the 53rd Sunday from 2023 is unused while the 52nd Monday and Tuesday from 2024 supply data for 2025, marked in green." width="90%" style="display: block; margin: auto;"></p>
<p>This provides stable results across leap years without inventing new
patterns that never existed in the input.</p>
</div>
<div class="section level2">
<h2 id="guard-rails-when-we-do-not-have-enough-history">Guard rails when we do not have enough history<a class="anchor" aria-label="anchor" href="#guard-rails-when-we-do-not-have-enough-history"></a>
</h2>
<p>If we try to extrapolate further — say we only have a single month of
data and request an entire year — the number of missing days is greater
than two. In that case we deliberately avoid
<code><a href="../reference/fill_from_past.html">fill_from_past()</a></code> and emit a warning so that users can fetch
more data instead of silently manufacturing values.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">short_month</span> <span class="op">&lt;-</span> <span class="fu">timefully</span><span class="fu">::</span><span class="va"><a href="../reference/dtf.html">dtf</a></span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">month</span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">new_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adapt_timeseries.html">adapt_timeseries</a></span><span class="op">(</span></span>
<span>  <span class="va">short_month</span>,</span>
<span>  start_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2025-04-15"</span><span class="op">)</span>,</span>
<span>  end_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2025-05-15"</span><span class="op">)</span>,</span>
<span>  tzone <span class="op">=</span> <span class="st">"Europe/Paris"</span>,</span>
<span>  fill_gaps <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">new_range</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">month</span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span> <span class="op">==</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,440 × 3</span></span></span>
<span><span class="co">#&gt;    datetime            solar building</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2025-05-01 <span style="color: #949494;">00:00:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2025-05-01 <span style="color: #949494;">00:15:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2025-05-01 <span style="color: #949494;">00:30:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2025-05-01 <span style="color: #949494;">00:45:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2025-05-01 <span style="color: #949494;">01:00:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2025-05-01 <span style="color: #949494;">01:15:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2025-05-01 <span style="color: #949494;">01:30:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2025-05-01 <span style="color: #949494;">01:45:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2025-05-01 <span style="color: #949494;">02:00:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2025-05-01 <span style="color: #949494;">02:15:00</span>    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,430 more rows</span></span></span></code></pre></div>
<p>With these safeguards in place we get the best of both worlds:
automatic repairs for the full-year edge case, and clear feedback when
the input is simply too small to support the requested period.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marc Cañigueral.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
